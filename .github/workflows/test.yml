name: SDK Test run

on:
  push:
    branches: [ TP-10364 ]

  jobs:
    sdk-integration-test:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout SDK
          uses: actions/checkout@v4

        - name: Get SDK version from pom.xml
          id: get-version
          run: |
            VERSION=$(grep -m1 '<version>' pom.xml | sed -E 's/.*<version>([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"

        - name: Authenticate with AWS ECR
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: eu-central-1

        - name: Login to Amazon ECR
          uses: aws-actions/amazon-ecr-login@v1

        - name: Pull sdk-test Docker image
          run: docker pull 789140966122.dkr.ecr.eu-central-1.amazonaws.com/sdk-test:latest

        - name: Run sdk-test Maven tests inside Docker
          run: |
            docker run --rm \
              -e appKey="${{ secrets.APP_KEY }}" \
              -e appId="${{ vars.APP_ID }}" \
              -e userId="${{ vars.USER_ID }}" \
              -e supplierId="${{ vars.SUPPLIER_ID }}" \
              -v "$HOME/.m2:/root/.m2" \
              789140966122.dkr.ecr.eu-central-1.amazonaws.com/sdk-test:latest \
              mvn test -Dsdk.version="${{ steps.get-version.outputs.version }}"
